<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SDGVM Update Project: C:/Users/markl/Dropbox/SDGVM/source/f03_ant/src/luna_methods.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="styleSheet.css" rel="stylesheet" type="text/css" />
<link href="styleSheetExtra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%">
  <tbody>
    <tr style="height: 100px;">
      <td id="projectLC3M" width="30%"><a href="http://lc3m.org"><img alt="Logo" src="images/LC3M2.png"/></a>
      </td>
      <td style="width=40%">
        <table width="100%">
          <tr> <td align="center"><div class="projectname"><span>S</span>heffield <span>D</span>ynamic <span>G</span>lobal</div></td></tr>
          <tr> <td align="center"><div class="projectname"><span>V</span>egetation <span>M</span>odel</div></td></tr>
        </table>
      </td>
      <td id="projectSU" width="30%"><a href="http://www.sheffield.ac.uk"><img alt="Logo" src="images/Sheffield_University2.png"/></a>
      </td>
     </tr>
   </tbody>
  </table>
</div> <!-- Title area div
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('luna__methods_8f90_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">luna_methods.f90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="luna__methods_8f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html">    1</a></span>&#160;<span class="keyword">module</span> <a class="code" href="namespaceluna__methods.html">luna_methods</a></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">!********************************************************************************************************************************************************************** </span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">! !DESCRIPTION:</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">! Calculates Nitrogen fractionation within the leaf, based on optimum calculated fractions in rubisco, cholorophyll, </span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">! Respiration and Storage. Based on Xu et al. 2012 and Ali et al 2015.In Review </span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">! REVISION HISTORY:</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">! version 1.0, by Chonggang Xu, Ashehad Ali and Rosie Fisher. July 14  2015.</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">! version 0.1, by Chonggang Xu, Ashehad Ali and Rosie Fisher. October 30 2014. </span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">!********************************************************************************************************************************************************************** </span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;     </div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keywordtype">use </span><a class="code" href="namespacereal__precision.html">real_precision</a></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keywordtype">use </span><a class="code" href="namespaceproductivity__luna__methods.html">productivity_luna_methods</a></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keywordtype">implicit none</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">contains</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;     </div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">!********************************************************************************************************************************************************************** </span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">! this subroutine updates the photosynthetic capacity as determined by Vcmax25 and Jmax25</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;   </div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">!subroutine Update_Photosynthesis_Capacity(bounds, fn, filterp, </span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">!&amp;dayl_factor, atm2lnd_inst, temperature_inst, canopystate_inst, </span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">!&amp;photosyns_inst, </span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">!&amp;surfalb_inst, solarabs_inst, waterstate_inst, frictionvel_inst)</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;     </div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">!Use the LUNA model to calculate the Nitrogen partioning </span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">!subroutine NitrogenAllocation(FNCa,forc_pbot10, relh10, CO2a10,O2a10, PARi10,PARimx10,rb10, hourpd, tair10, tleafd10, tleafn10, &amp;</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">!     Jmaxb0, Jmaxb1, Wc2Wjb0, relhExp,&amp;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">!     PNstoreold, PNlcold, PNetold, PNrespold, PNcbold, &amp;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">!     PNstoreopt, PNlcopt, PNetopt, PNrespopt, PNcbopt)</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespaceluna__methods.html#a1a163aa95715ebde3696a4337b9b8d84">luna</a>(z,vcmx25_z,jmx25_z,PNlc_z,enzs_z,rb10,sla,lnc,par240d,par240x, &amp;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160; CO2a10,o2a10,hourpd,relh10_in,tair10,gs_func,ftg0,ftg1,max_daily_pchg,ttype, &amp;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160; ftToptV,ftHaV,ftHdV,ftToptJ,ftHaJ,ftHdJ) </div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html#a1a163aa95715ebde3696a4337b9b8d84">   42</a></span>&#160;     </div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keywordtype">implicit none</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;     </div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">!real(dp), intent (in) :: FNCa                       !Area based functional nitrogen content (g N/m2 leaf)</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: sla                        <span class="comment">!Specific leaf area m2 g-1 DW</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: lnc                        <span class="comment">!Area based leaf nitrogen content (g N/m2 leaf)</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: relh10_in                  <span class="comment">!10-day mean relative humidity (unitless)</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: CO2a10                     <span class="comment">!10-day meanCO2 concentration in the air (Pa)</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: O2a10                      <span class="comment">!10-day mean O2 concentration in the air (Pa)</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: par240d                    <span class="comment">!10-day mean photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: par240x                    <span class="comment">!10-day mean 24hr maximum photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: rb10                       <span class="comment">!10-day mean boundary layer resistance</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: hourpd                     <span class="comment">!hours of light in a the day (hrs)</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tair10                     <span class="comment">!10-day running mean of the 2m temperature (oC)</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: max_daily_pchg             <span class="comment">! maximum daily proportional change in vcmax or Jmax</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">! the below thre variables are commented out as the t pars are assumed the same as tair and pressure is assumed constant in SDGVM</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">!real(dp), intent (in) :: tleafd10                   !10-day running mean of daytime leaf temperature (oC) </span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">!real(dp), intent (in) :: tleafn10                   !10-day running mean of nighttime leaf temperature (oC) </span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">!real(dp), intent (in) :: forc_pbot10                !10-day mean air pressure (Pa)</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">! the below variables are commented out because they are declared as parameters below</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">!real(dp), intent (in) :: Jmaxb0                     !baseline proportion of nitrogen allocated for electron transport rate (unitless)</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">!real(dp), intent (in) :: Jmaxb1                     !coefficient determining the response of electron transport rate to light availability (unitless) </span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">!real(dp), intent (in) :: Wc2Wjb0                    !the baseline ratio of rubisco-limited rate vs light-limited photosynthetic rate (Wc:Wj)</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">!real(dp), intent (in) :: relhExp                    !specifies the impact of relative humidity on electron transport rate (unitless)</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">! the below variables are commented as they declared as local variables below </span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">!real(dp), intent (in) :: PNstoreold                 !old value of the proportion of nitrogen allocated to storage (unitless)</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">!real(dp), intent (in) :: PNlcold                    !old value of the proportion of nitrogen allocated to light capture (unitless)</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">!real(dp), intent (in) :: PNetold                    !old value of the proportion of nitrogen allocated to electron transport (unitless)</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">!real(dp), intent (in) :: PNrespold                  !old value of the proportion of nitrogen allocated to respiration (unitless)</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">!real(dp), intent (in) :: PNcbold                    !old value of the proportion of nitrogen allocated to carboxylation (unitless)  </span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">!real(dp), intent (out):: PNstoreopt                 !optimal proportion of nitrogen for storage </span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">!real(dp), intent (out):: PNlcopt                    !optimal proportion of nitrogen for light capture </span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">!real(dp), intent (out):: PNetopt                    !optimal proportion of nitrogen for electron transport </span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">!real(dp), intent (out):: PNrespopt                  !optimal proportion of nitrogen for respiration </span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">!real(dp), intent (out):: PNcbopt                    !optial proportion of nitrogen for carboxyaltion  </span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftToptV                  <span class="comment">!optimum temp for vcmax (oC)</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftHaV                    <span class="comment">!activation energy for vcmax</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftHdV                    <span class="comment">!deactivation energy for vcmax</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftToptJ                  <span class="comment">!optimum temp for jmax (oC)</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftHaJ                    <span class="comment">!activation energy for jmax</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>   :: ftHdJ                    <span class="comment">!deactivation energy for jmax</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">intent (in)</span>  :: z                        <span class="comment">!canopy layer</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">intent (in)</span>  :: ttype                    <span class="comment">!temperature scaling method to use</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span>:: vcmx25_z                 <span class="comment">!vcmax25</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span>:: jmx25_z                  <span class="comment">!jmx25</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span>:: PNlc_z                   <span class="comment">!optimal proportion of nitrogen for carboxylation  </span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span>:: enzs_z                   <span class="comment">!enzyme decay state</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">!intermediate variables</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keywordtype">real(dp)</span> :: FNCa                       <span class="comment">!Area based functional nitrogen content (g N/m2 leaf)</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="keywordtype">real(dp)</span> :: SNCa                       <span class="comment">!Area based structural nitrogen content (g N/m2 leaf)</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="keywordtype">real(dp)</span> :: par240d_z                  <span class="comment">!10-day mean photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keywordtype">real(dp)</span> :: par240x_z                  <span class="comment">!10-day mean 24hr maximum photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keywordtype">real(dp)</span> :: relh10                     <span class="comment">!10-day mean relative humidity (unitless)</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="keywordtype">real(dp)</span> :: PARi10                     <span class="comment">!10-day mean photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keywordtype">real(dp)</span> :: PARimx10                   <span class="comment">!10-day mean 24hr maximum photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keywordtype">real(dp)</span> :: PNlcold                    <span class="comment">!old value of the proportion of nitrogen allocated to light capture (unitless)</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="keywordtype">real(dp)</span> :: PNetold                    <span class="comment">!old value of the proportion of nitrogen allocated to electron transport (unitless)</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="keywordtype">real(dp)</span> :: PNrespold                  <span class="comment">!old value of the proportion of nitrogen allocated to respiration (unitless)</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="keywordtype">real(dp)</span> :: PNcbold                    <span class="comment">!old value of the proportion of nitrogen allocated to carboxylation (unitless)  </span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="keywordtype">real(dp)</span> :: PNstoreopt                 <span class="comment">!optimal proportion of nitrogen for storage </span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="keywordtype">real(dp)</span> :: PNlcopt                    <span class="comment">!optimal proportion of nitrogen for light capture </span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="keywordtype">real(dp)</span> :: PNetopt                    <span class="comment">!optimal proportion of nitrogen for electron transport </span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="keywordtype">real(dp)</span> :: PNrespopt                  <span class="comment">!optimal proportion of nitrogen for respiration </span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="keywordtype">real(dp)</span> :: PNcbopt                    <span class="comment">!optial proportion of nitrogen for carboxyaltion  </span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keywordtype">real(dp)</span> :: Carboncost1                             <span class="comment">!absolute amount of carbon cost associated with maintenance respiration due to deccrease in light capture nitrogen(g dry mass per day) </span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="keywordtype">real(dp)</span> :: Carboncost2                             <span class="comment">!absolute amount of carbon cost associated with maintenance respiration due to increase in light capture nitrogen(g dry mass per day) </span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keywordtype">real(dp)</span> :: Carbongain1                             <span class="comment">!absolute amount of carbon gain associated with maintenance respiration due to deccrease in light capture nitrogen(g dry mass per day) </span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="keywordtype">real(dp)</span> :: Carbongain2                             <span class="comment">!absolute amount of carbon gain associated with maintenance respiration due to increase in light capture nitrogen(g dry mass per day) </span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="keywordtype">real(dp)</span> :: Fc                                      <span class="comment">!the temperature adjustment factor for Vcmax </span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="keywordtype">real(dp)</span> :: Fj                                      <span class="comment">!the temperature adjustment factor for Jmax </span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="keywordtype">real(dp)</span> :: PNlc                                    <span class="comment">!the current nitrogen allocation proportion for light capture</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="keywordtype">real(dp)</span> :: Jmax                                    <span class="comment">!the maximum electron transport rate (umol/m2/s) </span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="keywordtype">real(dp)</span> :: JmaxCoef                                <span class="comment">!coefficient determining the response of electron transport rate to light availability (unitless) and humidity</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="keywordtype">real(dp)</span> :: Jmaxb0act                               <span class="comment">!base value of Jmax (umol/m2/s) </span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="keywordtype">real(dp)</span> :: JmaxL                                   <span class="comment">!the electron transport rate with maximum daily radiation (umol/m2/s)  </span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keywordtype">real(dp)</span> :: JmeanL                                  <span class="comment">!the electron transport rate with mean radiation (umol/m2/s) </span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="keywordtype">real(dp)</span> :: Nstore                                  <span class="comment">!absolute amount of nitrogen allocated to storage (gN/m2 leaf)</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="keywordtype">real(dp)</span> :: Nresp                                   <span class="comment">!absolute amount of nitrogen allocated to respiration (gN/m2 leaf) </span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordtype">real(dp)</span> :: Nlc                                     <span class="comment">!absolute amount of nitrogen allocated to light capture (gN/m2 leaf) </span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="keywordtype">real(dp)</span> :: Net                                     <span class="comment">!absolute amount of nitrogen allocated to electron transport (gN/m2 leaf) </span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="keywordtype">real(dp)</span> :: Ncb                                     <span class="comment">!absolute amount of nitrogen allocated to carboxylation (gN/m2 leaf) </span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="keywordtype">real(dp)</span> :: Nresp1                                  <span class="comment">!absolute amount of nitrogen allocated to respiration due to increase in light capture nitrogen(gN/m2 leaf)  </span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="keywordtype">real(dp)</span> :: Nlc1                                    <span class="comment">!absolute amount of nitrogen allocated to light capture due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="keywordtype">real(dp)</span> :: Net1                                    <span class="comment">!absolute amount of nitrogen allocated to electron transport due to increase in light capture nitrogen(gN/m2 leaf)</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="keywordtype">real(dp)</span> :: Ncb1                                    <span class="comment">!absolute amount of nitrogen allocated to carboyxlation due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="keywordtype">real(dp)</span> :: Nresp2                                  <span class="comment">!absolute amount of nitrogen allocated to respiration due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="keywordtype">real(dp)</span> :: Nlc2                                    <span class="comment">!absolute amount of nitrogen allocated to light capture due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="keywordtype">real(dp)</span> :: Net2                                    <span class="comment">!absolute amount of nitrogen allocated to electron transport due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keywordtype">real(dp)</span> :: Ncb2                                    <span class="comment">!absolute amount of nitrogen allocated to carboxylation due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="keywordtype">real(dp)</span> :: PSN                                     <span class="comment">!g carbon photosynthesized per day per unit(m2) of leaf</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">real(dp)</span> :: RESP                                    <span class="comment">!g carbon respired per day per unit(m2) of leaf due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="keywordtype">real(dp)</span> :: PSN1                                    <span class="comment">!g carbon photosynthesized per day per unit(m2) of leaf due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="keywordtype">real(dp)</span> :: RESP1                                   <span class="comment">!g carbon respired per day per unit(m2) of leaf due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keywordtype">real(dp)</span> :: PSN2                                    <span class="comment">!g carbon photosynthesized per day per unit(m2) of leaf due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordtype">real(dp)</span> :: RESP2                                   <span class="comment">!g carbon respired per day per unit(m2) of leaf</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keywordtype">real(dp)</span> :: Npsntarget                              <span class="comment">!absolute amount of target nitrogen for photosynthesis(gN/m2 leaf) </span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keywordtype">real(dp)</span> :: Npsntarget1                             <span class="comment">!absolute amount of target nitrogen for photosynthesis due to increase in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordtype">real(dp)</span> :: Npsntarget2                             <span class="comment">!absolute amount of target nitrogen for photosynthesis due to decrease in light capture nitrogen(gN/m2 leaf) </span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="keywordtype">real(dp)</span> :: NUEj                                    <span class="comment">!nitrogen use efficiency for electron transport under current environmental conditions </span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="keywordtype">real(dp)</span> :: NUEc                                    <span class="comment">!nitrogen use efficiency for carboxylation under current environmental conditions  </span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="keywordtype">real(dp)</span> :: NUEjref                                 <span class="comment">!nitrogen use efficiency for electron transport under reference environmental conditions (25oC and 385ppm Co2) </span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keywordtype">real(dp)</span> :: NUEcref                                 <span class="comment">!nitrogen use efficiency for carboxylation under reference environmental conditions (25oC and 385ppm Co2) </span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="keywordtype">real(dp)</span> :: NUEr                                    <span class="comment">!nitrogen use efficiency for respiration </span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="keywordtype">real(dp)</span> :: PARi10c                                 <span class="comment">!10-day mean constrained photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="keywordtype">real(dp)</span> :: PARimx10c                               <span class="comment">!10-day mean constrained 24hr maximum photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="keywordtype">real(dp)</span> :: Kj2Kcref                                <span class="comment">!the ratio of rubisco-limited photosynthetic rate (Wc) to light limited photosynthetic rate (Wj)</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="keywordtype">real(dp)</span> :: PNlcoldi                                <span class="comment">!old value of the proportion of nitrogen allocated to light capture (unitless) </span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keywordtype">real(dp)</span> :: Kj2Kc                                   <span class="comment">!the ratio of Wc to Wj under changed conditions </span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keywordtype">real(dp)</span> :: Kc                                      <span class="comment">!conversion factors for Vc,max to Wc </span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="keywordtype">real(dp)</span> :: Kj                                      <span class="comment">!conversion factor for electron transport rate to Wj </span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="keywordtype">real(dp)</span> :: theta                                   <span class="comment">!efficiency of light energy conversion (unitless) </span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="keywordtype">real(dp)</span> :: chg                                     <span class="comment">!the nitrogen change per interation</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordtype">real(dp)</span> :: chg_constrn                             <span class="comment">!the nitrogen change per interation</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keywordtype">real(dp)</span> :: chg_per_step                            <span class="comment">!the nitrogen change per interation</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="keywordtype">real(dp)</span> :: Vcmaxnight                              <span class="comment">!Vcmax during night (umol/m2/s)</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="keywordtype">real(dp)</span> :: ci                                      <span class="comment">!inter-cellular CO2 concentration (Pa)</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">!real(dp) :: theta_cj                                !interpolation coefficient</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="keywordtype">real(dp)</span> :: tleafd10                   <span class="comment">!10-day running mean of daytime leaf temperature (oC) </span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keywordtype">real(dp)</span> :: tleafn10                   <span class="comment">!10-day running mean of nighttime leaf temperature (oC) </span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="keywordtype">real(dp)</span> :: forc_pbot10                <span class="comment">!10-day mean air pressure (Pa)</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="keywordtype">real(dp)</span> :: tleafd10c                               <span class="comment">!10-day mean daytime leaf temperature, contrained for physiological range (oC)</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordtype">real(dp)</span> :: tleafn10c                               <span class="comment">!10-day mean leaf temperature for night, constrained for physiological range (oC)</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keywordtype">real(dp)</span> :: Vcmax                                   <span class="comment">!the maximum carboxyaltion rate (umol/m2/s) </span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="keywordtype">real(dp)</span> :: vcmx25_opt   </div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keywordtype">real(dp)</span> :: jmx25_opt   </div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keywordtype">real(dp)</span> :: rabsorb</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keywordtype">real(dp)</span> :: radmax2mean </div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="keywordtype">integer</span> :: KcKjFlag                                <span class="comment">!flag to indicate whether to update the Kc and Kj using the photosynthesis subroutine; 0--Kc and Kj need to be calculated; 1--Kc and Kj is prescribed.</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keywordtype">integer</span> :: jj                                      <span class="comment">!index record fo the number of iterations</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="keywordtype">integer</span> :: increase_flag                           <span class="comment">!whether to increase or decrease</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">!pass thru variables</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftg0                       <span class="comment">!the intercept of the stomatal conductance equation</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftg1                       <span class="comment">!the slope of the stomatal conductance equation </span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">intent (in)</span>:: gs_func                    <span class="comment">!flag to indicate which stomatal conductance function to use </span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">! functions</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">!real(dp) :: RespTBernacchi</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">!real(dp) :: t_scalar                                !temperature scaling factor for Vcmax or Jmax </span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">!----------------------------------------------------------------------! </span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">!Constants  </span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: rhol = 0.075                     <span class="comment">! leaf reflectance: 1=vis, 2=nir  </span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: taul = 0.075                     <span class="comment">! leaf transmittance: 1=vis, 2=nir </span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cb   = 1.78                    <span class="comment">! nitrogen use effiency for choloraphyll for light capture, see Evans 1989  </span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cv   = 1.2d-5 * 3600.          <span class="comment">! conversion factor from umol CO2 to g carbon</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Kc25 = 40.49                   <span class="comment">! Mechalis constant of CO2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Ko25 = 27840                   <span class="comment">! Mechalis constant of O2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cp25 = 4.275                   <span class="comment">! CO2 compensation point at 25C (Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Fc25 = 294.2                   <span class="comment">! Fc25 = 6.22*47.3 #see Rogers (2014) Photosynthesis Research </span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Fj25 = 1257.0                  <span class="comment">! Fj25 = 8.06*156 # #see COSTE 2005 and Xu et al 2012</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: NUEr25 = 33.69                 <span class="comment">! nitrogen use efficiency for respiration, see Xu et al 2012</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: O2ref = 209460.0               <span class="comment">! ppm of O2 in the air</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: CO2ref = 380.0                 <span class="comment">! reference CO2 concentration for calculation of reference NUE. </span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: forc_pbot_ref = 101325.0       <span class="comment">! reference air pressure for calculation of reference NUE</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Jmaxb0 = 0.0311                <span class="comment">! the baseline proportion of nitrogen allocated for electron transport (J)     </span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Jmaxb1 = 0.1745                <span class="comment">! the baseline proportion of nitrogen allocated for electron transport (J)    </span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Wc2Wjb0 = 0.8054               <span class="comment">! the baseline ratio of rubisco limited rate vs light limited photosynthetic rate (Wc:Wj) </span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: relhExp = 6.0999               <span class="comment">! electron transport parameters related to relative humidity</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: NMCp25 = 0.715                 <span class="comment">! estimated by assuming 80% maintenance respiration is used for photosynthesis enzyme maintenance</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Trange1 = 5.0                  <span class="comment">! lower temperature limit (oC) for nitrogen optimization  </span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Trange2 = 42.0                 <span class="comment">! upper temperature limit (oC) for nitrogen optimization</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: SNC = 0.004                    <span class="comment">! structural nitrogen concentration (g N g-1 C)</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: mp = 9.0                       <span class="comment">! slope of stomatal conductance; this is used to estimate model parameter, but may need to be updated from the physiology file, </span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">!SDGVM PAR units are in molm-2s-1</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: PARLowLim = 200.0d-6             <span class="comment">! minimum photosynthetically active radiation for nitrogen optimization</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: minrelh = 0.25                 <span class="comment">! minimum relative humdity for nitrogen optimization</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;     </div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;   </div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">!print*, z,vcmx25_z,jmx25_z,PNlc_z,enzs_z,lnc,par240d</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;   </div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">! SDGVM asssumes daily average temperatures for the leaf &amp; constant pressure </span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;tleafd10    = tair10</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;tleafn10    = tair10</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;forc_pbot10 = 101325.</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160; </div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">!SDGVM PAR units are in molm-2s-1</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">!par240d_z   = par240d * 1d6</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">!par240x_z   = par240x * 1d6</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;par240d_z   = par240d</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;par240x_z   = par240x</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">! LUNA expects RH in proportion i.e. 0-1, SDGVM in %      </span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;relh10      = relh10_in * 1.d-2</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; </div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">! SLA is fixed through the canopy in SDGVM and lnc is pre-determined according to Beer&#39;s Law scaling or similar </span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">! - therefore relCLNCa, PARTop are not needed</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">! PAR is already passed to this routine in umol m-2 s-1 (check not day)</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">! - therefore the intermediary steps to convert from wm-2 are not necessary</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">!SNCa     =  1.0/slatop(ft) * SNC !(Eq A3)</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;snca = 1.0/sla*0.48 * snc     <span class="comment">!(Eq A3)</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;fnca = lnc - snca                 <span class="comment">!(Eq A4)</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">! for SDGVM the distinction between sunlit and non-sunlit leaves is not made in the LUNA model</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">! - this is because during the day leaves experience both sunlit and non-sunlit states so  </span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">! par240d/x_z is 10-day mean/maximum PAR for leaves in a canopy layer</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">! rabsorb is ratio of absorbed light to incident light (rhol and taul are reflectance and transmittance)</span></div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;rabsorb     = 1.0-rhol-taul</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;radmax2mean = par240x_z / par240d_z</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;pari10      = par240d_z / rabsorb</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;parimx10    = pari10 * radmax2mean</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">!nitrogen allocation model-start          </span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">!PNlcold     = PNlc_z</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;pnlcold     = 0.2 / lnc </div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;pnetold     = 0.0</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;pnrespold   = 0.0</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;pncbold     = 0.0                                     </div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">!end brought in from above subroutine </span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">! this call to N allocation has been replaced by the N allocation code </span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">!call NitrogenAllocation(FNCa,forc_pbot10(p), relh10, CO2a10, O2a10, PARi10, PARimx10, rb10, hourpd, &amp;</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">!     tair10, tleafd10, tleafn10, &amp;</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">!     Jmaxb0, Jmaxb1, Wc2Wjb0, relhExp,  PNstoreold, PNlcold, PNetold, PNrespold, &amp;</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">!     PNcbold, PNstoreopt, PNlcopt, PNetopt, PNrespopt, PNcbopt)</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">! set referfence NUE parameters </span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">! - using sinlge common NUE function fed with default values as arguments</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">! call NUEref(NUEjref, NUEcref, Kj2Kcref)</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">!print*, &#39;LUNA start&#39;</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keyword">call </span><a class="code" href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">nue</a>(o2ref*0.1013, 0.7*co2ref*0.1013, 25.0_dp, 25.0_dp, &amp;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; nuejref, nuecref, kj2kcref,ttype,fttoptv,fthav,fthdv, &amp;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; fttoptj,fthaj,fthdj)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">! appears theta_cj is not necessary for this subroutine</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">!theta_cj = 0.95</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">! it&#39;s not currently clear to me where PNstoreold is passed from in the original code</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">!Nstore   = PNstoreold * FNCa                         !FNCa * proportion of storage nitrogen in functional nitrogen</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;nlc      = pnlcold    * fnca                         <span class="comment">!FNCa * proportion of light capturing nitrogen in functional nitrogen</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;net      = pnetold    * fnca                         <span class="comment">!FNCa * proportion of light harvesting (electron transport) nitrogen in functional nitrogen</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;nresp    = pnrespold  * fnca                         <span class="comment">!FNCa * proportion of respiration nitrogen in functional nitrogen</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;ncb      = pncbold    * fnca                         <span class="comment">!FNCa * proportion of carboxylation nitrogen in functional nitrogen</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keywordflow">if</span> (nlc &gt; fnca * 0.5) nlc = 0.5 * fnca</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;pnlc     = pnlcold</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;pnlcoldi = pnlcold  - 0.001</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">! constrain the physiological range of PAR and t</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;pari10c   = max(parlowlim, pari10)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;parimx10c = max(parlowlim, parimx10)</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;tleafd10c = min(max(tleafd10, trange1), trange2)  </div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;tleafn10c = min(max(tleafn10, trange1), trange2) </div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">! initialse solver parameters </span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;ci            = 0.7 * co2a10 </div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;jmaxcoef      = jmaxb1 * ((hourpd / 12.0)**2.0) * &amp;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160; ( 1.0 - exp( -relhexp * max(relh10 - minrelh, 0.0) / &amp;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; (1.0 - minrelh) ) )</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;chg_per_step  = 0.02* fnca</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;increase_flag = 0</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;jj = 1</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="keywordflow">do</span> <span class="keywordflow">while</span> ( (pnlcoldi /= pnlc) .and. (jj &lt; 100) )      </div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;     </div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160; <span class="comment">! Fc is the scaling factor to go from leaf N invested in RuBisCO to Vcmax  </span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; <span class="comment">! Fj is the scaling factor to go from leaf N invested in elec trans to Jmax  </span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160; <span class="comment">!Fc   = VcmxTKattge(tair10, tleafd10c) * Fc25</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160; <span class="comment">!Fj   = JmxTKattge(tair10, tleafd10c)  * Fj25</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160; fc = <a class="code" href="namespaceproductivity__luna__methods.html#a84f8154a56c2ec0e23c62040167fe919">t_scalar</a>(tleafd10c,<span class="stringliteral">&#39;v&#39;</span>,ttype,fttoptv,fthav,fthdv,tair10,.false.)*fc25</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160; fj = <a class="code" href="namespaceproductivity__luna__methods.html#a84f8154a56c2ec0e23c62040167fe919">t_scalar</a>(tleafd10c,<span class="stringliteral">&#39;j&#39;</span>,ttype,fttoptj,fthaj,fthdj,tair10,.false.)*fj25</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160; </div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160; nuer = cv * nuer25 * ( <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafd10c) * hourpd + &amp;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;  <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafn10c) * (24.0 - hourpd) ) <span class="comment">!nitrogen use efficiency for respiration (g biomass/m2/day/g N)</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">!print*, &#39;LUNA do while loop&#39;</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  <span class="keyword">call </span><a class="code" href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">nue</a>(o2a10, ci, tair10, tleafd10c, nuej, nuec, kj2kc,ttype, &amp;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160; fttoptv,fthav,fthdv,fttoptj,fthaj,fthdj)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160; </div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160; kckjflag = 0</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  <span class="keyword">call </span><a class="code" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_ninvestments</a> (kckjflag,fnca, nlc, forc_pbot10,relh10, &amp;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; co2a10,o2a10, pari10c, parimx10c,rb10, hourpd, tair10, &amp;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160; tleafd10c,tleafn10c, &amp;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160; kj2kc, wc2wjb0, jmaxcoef, fc,fj, nuec, nuej, nuecref,nuejref,nuer, &amp;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160; kc, kj, ci, vcmax, jmax,jmeanl,jmaxl, net, ncb, nresp, psn, resp, &amp;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160; gs_func,ftg0,ftg1)      </div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">! target nitrogen allocated to photosynthesis, which may be lower or higher than Npsn_avail</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  npsntarget = nlc + ncb + net       </div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  pnlcoldi   = nlc / fnca</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  nstore     = fnca - npsntarget - nresp</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">!test the increase of light capture nitrogen</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="keywordflow">if</span> ( ((nstore &gt; 0.0) .and.(increase_flag == 1)) .or. (jj == 1) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    nlc2 = nlc + chg_per_step</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keywordflow">if</span> (nlc2 / fnca &gt; 0.95) nlc2 = 0.95 * fnca</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  </div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    kckjflag = 1</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keyword">call </span><a class="code" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_ninvestments</a> (kckjflag,fnca, nlc2, forc_pbot10, &amp;</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; relh10, co2a10,o2a10, pari10c, parimx10c,rb10, hourpd, &amp; </div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160; tair10, tleafd10c,tleafn10c, &amp;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; kj2kc, wc2wjb0, jmaxcoef, fc,fj, nuec, nuej, nuecref,nuejref,nuer, &amp;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160; kc,kj,ci,vcmax,jmax,jmeanl,jmaxl, net2, ncb2, nresp2, psn2, resp2, &amp;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160; gs_func,ftg0,ftg1)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  </div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    npsntarget2 = nlc2 + ncb2 + net2</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  </div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">!update the nitrogen change</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    carboncost2 = (npsntarget2 - npsntarget) * nmcp25 * cv * &amp;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; ( <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafd10c) * hourpd + <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafn10c) * &amp;</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; (24.0  - hourpd) )</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    carbongain2 =  psn2 - psn</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  </div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="keywordflow">if</span>( (carbongain2 &gt; carboncost2).and.(npsntarget2 + nresp2 &lt; 0.95 * fnca) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      nlc = nlc2</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;      net = net2</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;      ncb = ncb2</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      nstore = fnca - npsntarget2 - nresp2 </div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      <span class="keywordflow">if</span> (jj == 1) increase_flag = 1</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160; </div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160; <span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160; <span class="comment">!test the decrease of light capture nitrogen</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordflow">if</span> (increase_flag == 0) <span class="keywordflow">then</span>  </div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160; </div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">if</span> (nstore &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      nlc1 = nlc * 0.8 <span class="comment">!bigger step of decrease if it is negative            </span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;      nlc1 = nlc - chg_per_step</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160; </div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordflow">if</span> (nlc1 &lt; 0.05) nlc1 = 0.05</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    kckjflag = 1</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keyword">call </span><a class="code" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_ninvestments</a>(kckjflag,fnca, nlc1,forc_pbot10,relh10, &amp;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; co2a10,o2a10, pari10c, parimx10c,rb10, hourpd, &amp;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160; tair10, tleafd10c,tleafn10c, &amp;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160; kj2kc, wc2wjb0,jmaxcoef, fc,fj, nuec, nuej, nuecref,nuejref,nuer, &amp;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160; kc,kj,ci,vcmax,jmax,jmeanl,jmaxl,net1, ncb1, nresp1, psn1, resp1, &amp;</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160; gs_func,ftg0,ftg1)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  </div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    npsntarget1 = nlc1 + ncb1 + net1</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    carboncost1 = (npsntarget - npsntarget1) * nmcp25 * cv * &amp;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; ( <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafd10c) * hourpd + <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleafn10c) * &amp;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160; (24.0  - hourpd) )</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  carbongain1 =  psn - psn1</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  </div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span>( ((carbongain1 &lt; carboncost1) .and. (nlc1 &gt; 0.05)) .or.&amp;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160; (npsntarget + nresp &gt; 0.95 * fnca) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;      nlc    = nlc1 </div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;      net    = net1   </div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;      ncb    = ncb1</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      nstore = fnca - npsntarget1 - nresp1  </div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  </div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  pnlc = nlc / fnca</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160; </div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  jj = jj + 1  </div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">enddo</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">! record optimum proportions      </span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;pnlcopt    = nlc    / fnca</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;pnstoreopt = nstore / fnca</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;pncbopt    = ncb    / fnca</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;pnetopt    = net    / fnca</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;pnrespopt  = nresp  / fnca </div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">!brought in from parent subroutine</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;pnlc_z      = pnlcopt</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">! determine change in vcmax and jmax </span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;vcmx25_opt  = pncbopt * fnca * fc25</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;jmx25_opt   = pnetopt * fnca * fj25</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;chg         = vcmx25_opt-vcmx25_z</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;chg_constrn = min(abs(chg),vcmx25_z*max_daily_pchg)</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;vcmx25_z    = vcmx25_z+sign(1.0_dp,chg)*chg_constrn</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">!if(z==1) print*, vcmx25_opt,chg,vcmx25_z      </span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">!print*, vcmx25_opt,chg,vcmx25_z      </span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;chg         = jmx25_opt-jmx25_z</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;chg_constrn = min(abs(chg),jmx25_z*max_daily_pchg)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;jmx25_z     = jmx25_z+sign(1.0_dp,chg)*chg_constrn </div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">!print*, jmx25_opt,chg,jmx25_z      </span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="keywordflow">if</span>(enzs_z&lt;1.0) enzs_z = enzs_z * (1.0 + max_daily_pchg)</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="comment">!nitrogen allocation subroutine end  </span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">if</span>( isnan(vcmx25_z) .or. (vcmx25_z&gt;1000.) .or. (vcmx25_z&lt;0.) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="comment">!write(iulog, *) &#39;Error: Vc,mx25 become unrealistic (NaN,&gt;1000,</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Vc,mx25 become unrealistic (NaN,&gt;1000, or negative) for z=&#39;</span>, z</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Vcx25:&#39;</span>, vcmx25_z</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Jmx25:&#39;</span>, jmx25_z</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="comment">!write(iulog, *) &#39;LUNA env:&#39;,FNCa,forc_pbot10, relh10, CO2a10, </span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;LUNA env:&#39;</span>,fnca,forc_pbot10, relh10, co2a10, &amp;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160; o2a10, pari10, parimx10, rb10, hourpd, tair10, tleafd10, tleafn10</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="comment">!call endrun(msg=errmsg(__FILE__, __LINE__))</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  stop</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keywordflow">endif</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="keywordflow">if</span>( isnan(jmx25_z) .or. (jmx25_z&gt;1000.) .or. (jmx25_z&lt;0.) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160; <span class="comment">!write(iulog, *) &#39;Error: Jmx25 become unrealistic (NaN,&gt;1000, </span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Jmx25 become unrealistic (NaN,&gt;1000,or negative)for z=&#39;</span>, z</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Jmx25:&#39;</span>, jmx25_z</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;Error: Vcx25:&#39;</span>, vcmx25_z</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="comment">!write(iulog, *) &#39;LUNA env:&#39;, FNCa,forc_pbot10, relh10, CO2a10,</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keyword">write</span>(*, *) <span class="stringliteral">&#39;LUNA env:&#39;</span>, fnca,forc_pbot10, relh10, co2a10, &amp;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160; o2a10, pari10, parimx10, rb10,hourpd, tair10, tleafd10, tleafn10</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; <span class="comment">!call endrun(msg=errmsg(__FILE__, __LINE__))</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  stop</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="keywordflow">endif</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">!end brought in from above subroutine </span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespaceluna__methods.html#a1a163aa95715ebde3696a4337b9b8d84">luna</a></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_ninvestments</a> (KcKjFlag, FNCa, Nlc, forc_pbot10, &amp;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160; relh10,CO2a10,O2a10,PARi10,PARimx10,rb10,hourpd,tair10,tleafd10, &amp;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; tleafn10,Kj2Kc, Wc2Wjb0, JmaxCoef, Fc, Fj, NUEc, NUEj, NUEcref, &amp;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160; NUEjref,NUEr,Kc,Kj,ci,Vcmax,Jmax,JmeanL,JmaxL,Net,Ncb,Nresp,PSN, &amp;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; RESP,gs_func,ftg0,ftg1)</div><div class="line"><a name="l00467"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">  467</a></span>&#160;<span class="comment">!calculate the nitrogen investment for electron transport, carb10oxylation, respiration given a specified value </span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">!of nitrogen allocation in light capture [Nlc]. This equation are based on Ali et al 2015b.</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="keywordtype">implicit none</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordtype">integer</span>,<span class="keywordtype">intent (in)</span> :: KcKjFlag                   <span class="comment">!flag to indicate whether to update the Kc and Kj using the photosynthesis subroutine; 0--Kc and Kj need to be calculated; 1--Kc and Kj is prescribed.</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: FNCa                       <span class="comment">!Area based functional nitrogen content (g N/m2 leaf)</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: Nlc                        <span class="comment">!nitrogen content for light capture(g N/m2 leaf)</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: forc_pbot10                <span class="comment">!10-day mean air pressure (Pa)</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: relh10                     <span class="comment">!10-day mean relative humidity (unitless)</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: CO2a10                     <span class="comment">!10-day mean CO2 concentration in the air (Pa)</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: O2a10                      <span class="comment">!10-day mean O2 concentration in the air (Pa)</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: PARi10                     <span class="comment">!10-day mean photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: PARimx10                   <span class="comment">!10-day mean 24hr maximum photosynthetic active radiation on in a canopy (umol/m2/s)</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: rb10                       <span class="comment">!10-day mean boundary layer resistance (s/m)</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: hourpd                     <span class="comment">!hours of light in a the day (hrs)</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tair10                     <span class="comment">!10-day running mean of the 2m temperature (oC)</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tleafd10                   <span class="comment">!10-day mean daytime leaf temperature (oC) </span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tleafn10                   <span class="comment">!10-day mean nighttime leaf temperature (oC) </span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: Kj2Kc                      <span class="comment">!ratio:  Kj / Kc</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: Wc2Wjb0                    <span class="comment">!the baseline ratio of rubisco-limited rate vs light-limited photosynthetic rate (Wc:Wj)</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: JmaxCoef                   <span class="comment">!coefficient determining the response of electron transport rate to light availability (unitless) and humidity</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: Fc                         <span class="comment">!the temperature adjusted ratio of Vcmax to N invested in Vcmax  </span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: Fj                         <span class="comment">!the temperature adjusted ratio of  Jmax to N invested in electron trans </span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: NUEc                       <span class="comment">!nitrogen use efficiency for carboxylation </span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: NUEj                       <span class="comment">!nitrogen use efficiency for electron transport</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: NUEcref                    <span class="comment">!nitrogen use efficiency for carboxylation under reference climates</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: NUEjref                    <span class="comment">!nitrogen use efficiency for electron transport under reference climates</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: NUEr                       <span class="comment">!nitrogen use efficiency for respiration</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: Kc                      <span class="comment">!conversion factors from Vc,max to Wc </span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: Kj                      <span class="comment">!conversion factor from electron transport rate to Wj </span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: ci                      <span class="comment">!inter-cellular CO2 concentration (Pa) </span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: Vcmax                   <span class="comment">!the maximum carboxyaltion rate (umol/m2/s) </span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: Jmax                    <span class="comment">!the maximum electron transport rate (umol/m2/s) </span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: JmaxL                   <span class="comment">!the electron transport rate with maximum daily radiation (umol/m2/s)  </span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: JmeanL                  <span class="comment">!the electron transport rate with mean radiation (umol/m2/s) </span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: Net                     <span class="comment">!nitrogen content for electron transport(g N/m2 leaf)</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: Ncb                     <span class="comment">!nitrogen content for carboxylation(g N/m2 leaf)</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: Nresp                   <span class="comment">!nitrogen content for respiration(g N/m2 leaf)</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: PSN                     <span class="comment">!daily photosynthetic rate(g C/day/m2 leaf)</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>   :: RESP                    <span class="comment">!daily respiration rate(g C/day/m2 leaf)</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">!intermediate variables</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordtype">real(dp)</span> :: A                                       <span class="comment">!Gross photosynthetic rate (umol CO2/m2/s)</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="keywordtype">real(dp)</span> :: Wc2Wj                                   <span class="comment">!ratio: Wc/Wj  </span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="keywordtype">real(dp)</span> :: ELTRNabsorb                             <span class="comment">!absorbed electron rate, umol electron/m2 leaf /s</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keywordtype">real(dp)</span> :: Jmaxb0act                               <span class="comment">!base value of Jmax (umol/m2/s) </span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="keywordtype">real(dp)</span> :: theta_cj                                <span class="comment">!interpolation coefficient</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="keywordtype">real(dp)</span> :: theta                                   <span class="comment">!light absorption rate (0-1)</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="keywordtype">real(dp)</span> :: Vcmaxnight                              <span class="comment">!Vcmax during night (umol/m2/s)</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="keywordtype">real(dp)</span> :: Wc                                      <span class="comment">!rubisco-limited photosynthetic rate (umol/m2/s)</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="keywordtype">real(dp)</span> :: Wj                                      <span class="comment">!light limited photosynthetic rate (umol/m2/s)</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keywordtype">real(dp)</span> :: k_c      </div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordtype">real(dp)</span> :: k_o       </div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keywordtype">real(dp)</span> :: tau        </div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordtype">real(dp)</span> :: c_p        </div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="keywordtype">real(dp)</span> :: awc        </div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="keywordtype">real(dp)</span> :: gs        </div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="keywordtype">real(dp)</span> :: NUECHG                                  <span class="comment">!the nitrogen use efficiency change under current conidtions compared to reference climate conditions (25oC and 385 ppm )</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">!pass thru variables</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftg0                       <span class="comment">!the intercept of the stomatal conductance equation</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftg1                       <span class="comment">!the slope of the stomatal conductance equation </span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordtype">integer</span>,<span class="keywordtype">intent (in)</span> :: gs_func                    <span class="comment">!flag to indicate which stomatal conductance function to use </span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;<span class="comment">!parameters</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cb = 1.78                      <span class="comment">! nitrogen use effiency for choloraphyll for light capture, see Evans 1989  </span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cv = 1.2d-5 * 3600.            <span class="comment">! conversion factor from umol CO2 to g carbon</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Jmaxb0 = 0.0311                <span class="comment">! the baseline proportion of nitrogen allocated for electron transport (J)     </span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Kc25 = 40.49                   <span class="comment">! Mechalis constant of CO2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Ko25 = 27840.                  <span class="comment">! Mechalis constant of O2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cp25 = 4.275                   <span class="comment">! CO2 compensation point at 25C (Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;theta_cj    = 0.95</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;theta       = 0.292 / (1.0 + 0.076 / (nlc * cb))</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;eltrnabsorb = theta  * pari10</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;jmaxb0act   = jmaxb0 * fnca * fj</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">! adjusted for SDGVM units molm-2s-1</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;jmaxb0act   = jmaxb0act * 1d-6</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;jmax        = jmaxb0act + jmaxcoef * eltrnabsorb</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;jmaxl       = theta  * parimx10 / ( sqrt(1.0 + (theta * parimx10 / jmax)**2.0) )        </div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;nuechg      = (nuec / nuecref) * (nuejref / nuej)</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;wc2wj       = wc2wjb0 * (nuechg**0.5)</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;wc2wj       = min(1.0, wc2wj)</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;vcmax       = wc2wj * jmaxl * kj2kc</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;     </div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="comment">!added the two below lines for stability when not calculating LUNA everyday</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="comment">! - in the lowest canopy layers the solver sometimes returns negative values </span></div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">! - and with larger intervals between LUNA calcultions (~10 days) the max proportional change can equal 1</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">! - allowing returned Vcmax and Jmax to be below 0</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;vcmax       = max(1d-7,vcmax)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;jmax        = max(1d-7,jmax)</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;     </div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;jmeanl      = theta * pari10 / ( sqrt(1.0 + (eltrnabsorb / jmax)**2.0) )</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160; </div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">if</span>(kckjflag==0) <span class="keywordflow">then</span>      <span class="comment">!update the Kc,Kj, anc ci information</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160; </div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="comment">! From SDGVM - for consistency</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="comment">! in LUNA ko, kc, and tau are at the 10-day mean leaf temp</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  k_c = kc25 * exp((79430.0 / (8.31 * &amp;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleafd10)))</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  k_o = ko25 * exp((36380.0 / (8.31 * &amp;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleafd10)))</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  c_p = cp25 * exp((37830.0 / (8.31 * &amp;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleafd10)))</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="comment">!print*, &#39;LUNA  orig.&#39;, k_c,k_o,c_p,tleafd10</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; </div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="comment">!k_c  = exp(35.8   - 80.5 / (0.00831*(tleafd10+273.15)) )</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="comment">!k_o  = exp(9.6    - 14.51/ (0.00831*(tleafd10+273.15)) )</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="comment">!k_o  = k_o * 1.0d3</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="comment">!tau  = exp(-3.949 + 28.99/ (0.00831*(tleafd10+273.15)) )</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="comment">!c_p  = 0.5*O2a10/tau</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="comment">!print*, &#39;SDGVM orig.&#39;, k_c,k_o,c_p,tleafd10</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160; </div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">! this function is over-parameterised due to an old attempt to use the Brent solver that is currently not implemented</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">! Vcmax and J are also assumed to be in molm-2s-1 in SDGVM</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="comment">! ga and gs must be in molm-2s-1 - gs is a local variable calculated during the call to assimilation_calc</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment">! rd needs to be unpacked, ko, kc, and tau are also needed here </span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment">! z is the LAI layer that is currently under calculation - in SDGVM this only triggers print to screen for LAI layer 1        </span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">! call Photosynthesis_luna(forc_pbot10, tleafd10, relh10, CO2a10, O2a10,rb10, Vcmax, JmeanL, ci, Kc, Kj, A) </span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">! CALL ASSIMILATION_CALC(fshade,fsunlit,</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">!&amp;vmx,xvmax,rd,jshade,jsunlit,upt,qshade,</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">!&amp;qsunlit,t,rn,soil2g,wtwp,ga,rh,C3,kg,ko,kc,tau,p,oi,ca,</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">!&amp;a,gs,ci,day,mnth,oday,omnth,.FALSE.,gs_func,ftg0,ftg1,i)</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160; </div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="comment">! should rd be zero below? seems like maybe it should according to the code but by not including rd in the a,ci,gs solution this will underestimate ci</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment">! the below function calls the SDGVM calculation of assimilation, simultaneously solving A, gs, &amp; ci</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">! for the purposes of the LUNA model A (umolm-2s-1)  and ci (Pa) are returned and used in further calculations</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="comment">! inputs to this model are in Pa units and molm-2s-1 </span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="comment">!  CALL ASSIMILATION_CALC(0.0,1.0, &amp;</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="comment">! Vcmax,0.0,0.0,0.0,JmeanL,0.0,0.0, &amp;</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">! 0.0,tleafd10,1.0,1.0,0.0,rb10*1d2,relh10,1,1.0, &amp;</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="comment">! k_o,k_c,tau,forc_pbot10,O2a10,CO2a10,A,gs,ci,1,2,1,1,.FALSE., &amp;</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">! gs_func,ftg0,ftg1,2)</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  awc = k_c * (1.0 + o2a10 / k_o)</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  kj  = max(ci - c_p, 0.0) / (4.0 * ci + 8.0 * c_p)</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;  kc  = max(ci - c_p, 0.0) / (ci + awc)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160; </div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">! below else changed to endif</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">! different from original LUNA code as A in LUNA is smoothed</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="comment">! between Wc and Wj, and parameters have been calibrated to this</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="comment">! smoothing. Somewhat decouples LUNA from the SDGVM photosynthesis</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">! method which assumes the straight minimum of wc or wj but is</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="comment">! probably a reasonable compromise </span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="comment">!else</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="keywordflow">endif</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160; </div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">! as described above, satisfy the LUNA assumption of co-limitation</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment">! between wc and wj</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;wc = kc * vcmax</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;wj = kj * jmeanl</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="comment">!A  = (1.0 - theta_cj) * max(Wc, Wj) + theta_cj * min(Wc, Wj) </span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">! Vcmax and J are in molm-2s-1 because that&#39;s what SDGVM expects, so the above calculation gives Kc and Kj in molm-2s-1</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">! the below smoothing function is used for numercial stability,</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment">! at the solution Wj and Wc ought to be pretty similar due to the</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment">! encoded co-ordination hypothesis, therefore this smoothing</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="comment">! should not have a big effect on A calculated at the optimum</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;a  = ( (1.0 - theta_cj) * max(wc, wj) + theta_cj * min(wc, wj) ) * 1e6</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; </div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;<span class="comment">!endif</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">! Cv converts from umolm-2s-1 to gC m-2 hour-1</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;psn        = cv * a * hourpd</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="comment">!      Vcmaxnight = VcmxTKattge(tair10, tleafn10) / </span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="comment">!     &amp;VcmxTKattge(tair10, tleafd10) * Vcmax</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">! SDGVM assumes mean 24 hr air temp </span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;vcmaxnight = vcmax</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="comment">! again these calculations are adjusted to suit SDGVM molm-2s-1 units for Vcmax and Jmax </span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;resp       = cv * 0.015 * ( vcmax * hourpd + vcmaxnight * (24. - hourpd) ) * 1e6                </div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;net        = jmax  * 1e6 / fj</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;ncb        = vcmax * 1e6 / fc</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;nresp      = resp  / nuer</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;     </div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">!print*, A,RESP,Vcmax,Jmax</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160; </div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_ninvestments</a></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="comment">!Calculate the Nitrogen use effieciency dependence on CO2 and leaf temperature</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">nue</a>(o2a,ci,tgrow,tleaf,NUEj,NUEc,Kj2Kc, &amp;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160; ttype,ftToptV,ftHaV,ftHdV,ftToptJ,ftHaJ,ftHdJ)</div><div class="line"><a name="l00656"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">  656</a></span>&#160;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="comment">! this function can be used to calculate NUEref aswell, it just needs to be called with both temps at 25oC and a ci that maintains a ci:ca of 0.7</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">! uses module constants of Fc25, Fj25, tfrz, rgas</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordtype">implicit none</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: o2a                        <span class="comment">!air O2 partial presuure (Pa)</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ci                         <span class="comment">!leaf inter-cellular [CO2] (Pa) - originally incorrectly labelled as PPM</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tgrow                      <span class="comment">!10 day growth temperature (oC), 24 hour mean temperature</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: tleaf                      <span class="comment">!leaf temperature (oC)</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftToptV                    <span class="comment">!optimum temp for vcmax (oC)</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftHaV                      <span class="comment">!activation energy for vcmax</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftHdV                      <span class="comment">!deactivation energy for vcmax</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftToptJ                    <span class="comment">!optimum temp for jmax (oC)</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftHaJ                      <span class="comment">!activation energy for jmax</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span> :: ftHdJ                      <span class="comment">!deactivation energy for jmax</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="comment">!integer, intent (in):: ttype                      !temperature scaling method to use</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="keywordtype">integer</span>:: ttype                      <span class="comment">!temperature scaling method to use</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>:: NUEj                       <span class="comment">!nitrogen use efficiency for electron transport under refernce environmental conditions (25oC and 385 ppm co2)</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>:: NUEc                       <span class="comment">!nitrogen use efficiency for carboxylation under reference environmental conditions  (25oC and 385 ppm co2)</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (out)</span>:: Kj2Kc                      <span class="comment">!the ratio of Kj to Kc </span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="comment">!----------------------------------------------------------------------!</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">!intermediate variables</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordtype">real(dp)</span> :: Fj                                      <span class="comment">!the temperature adjusted factor for Jmax </span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keywordtype">real(dp)</span> :: Fc                                      <span class="comment">!the temperature adjusted factor for Vcmax </span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordtype">real(dp)</span> :: Kc                                      <span class="comment">!conversion factor from Vcmax to Wc </span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordtype">real(dp)</span> :: Kj                                      <span class="comment">!conversion factor from J to W </span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="keywordtype">real(dp)</span> :: k_o                                     <span class="comment">!Rubsico O2 specifity</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="keywordtype">real(dp)</span> :: k_c                                     <span class="comment">!Rubsico CO2 specifity</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordtype">real(dp)</span> :: awc                                     <span class="comment">!second deminator term for rubsico limited carboxylation rate based on Farquhar model</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">real(dp)</span> :: c_p                                     <span class="comment">!CO2 compenstation point (Pa)</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;<span class="keywordtype">real(dp)</span> :: tau</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;<span class="comment">!real(dp) :: t_scalar                                !temperature scaling factor for Vcmax or Jmax </span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Fc25 = 294.2               <span class="comment">! Fc25 = 6.22*47.3 #see Rogers (2014) Photosynthesis Research </span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Fj25 = 1257.0              <span class="comment">! Fj25 = 8.06*156  #see COSTE 2005 and Xu et al 2012</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Kc25 = 40.49               <span class="comment">! Mechanis constant of CO2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Ko25 = 27840.              <span class="comment">! Mechanis constant of O2 for rubisco(Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">parameter</span> :: Cp25 = 4.275               <span class="comment">! CO2 compensation point at 25C (Pa), Bernacchi et al (2001) Plant, Cell and Environment 24:253-259</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;   </div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="comment">!print*, &#39;LUNA NUE, ttype:&#39;, ttype</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="comment">!Fc  = VcmxTKattge(tgrow, tleaf) * Fc25</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="comment">!Fj  = JmxTKattge(tgrow, tleaf)  * Fj25</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;fc  = <a class="code" href="namespaceproductivity__luna__methods.html#a84f8154a56c2ec0e23c62040167fe919">t_scalar</a>(tleaf,<span class="stringliteral">&#39;v&#39;</span>,ttype,fttoptv,fthav,fthdv,tgrow,.false.)*fc25</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;fj  = <a class="code" href="namespaceproductivity__luna__methods.html#a84f8154a56c2ec0e23c62040167fe919">t_scalar</a>(tleaf,<span class="stringliteral">&#39;j&#39;</span>,ttype,fttoptj,fthaj,fthdj,tgrow,.false.)*fj25</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160; </div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;k_c = kc25 * exp((79430.0 / (8.31 * &amp;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleaf)))</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;k_o = ko25 * exp((36380.0 / (8.31 * &amp;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleaf)))</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;c_p = cp25 * exp((37830.0 / (8.31 * &amp;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160; 298.15)) * (1.0 - (298.15) / (273.15 + tleaf)))</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">!print*, &#39;LUNA  orig.&#39;, k_c,k_o,c_p,tleaf</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160; </div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="comment">! From SDGVM - for consistency</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;<span class="comment">! in LUNA ko, kc, and tau are at the 10-day mean leaf temp</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="comment">! in SDGVM these are all in Pa</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;<span class="comment">!k_c = exp(35.8   - 80.5 /(8.31d-3*(tleaf+273.15)))</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="comment">!k_o = exp(9.6    - 14.51/(8.31d-3*(tleaf+273.15)))</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment">!k_o = k_o*1.d3</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">!tau = exp(-3.949 + 28.99/(8.31d-3*(tleaf+273.15)))</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">!c_p = 0.5*o2a/tau</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">!print*, &#39;SDGVM orig.&#39;, k_c,k_o,c_p</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;     </div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;awc = k_c * ( 1.0 + o2a/k_o )</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;kj  = max( ci-c_p,0.0 ) / ( 4.0*ci + 8.0*c_p )</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;kc  = max( ci-c_p,0.0 ) / ( ci+awc )</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;     </div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;nuej  = kj * fj</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;nuec  = kc * fc  </div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;kj2kc = kj / kc</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;     </div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">nue</a></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="comment">!Calculate the temperature response for respiration, following Bernacchi PCE 2001</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keyword">function </span><a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>(tleaf)</div><div class="line"><a name="l00737"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">  737</a></span>&#160;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="keywordtype">implicit none</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordtype">real(dp)</span> <a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent(in)</span>:: tleaf  <span class="comment">!leaf temperature (oC)</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="comment">!RespTBernacchi= exp(18.72-46.39/(rgas*1.e-6 *(tleaf+tfrz)))</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a>= exp( 18.72-46.39/(8.31d-3 * &amp;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; (tleaf+273.15)) )</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="keyword">end function </span><a class="code" href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">resptbernacchi</a></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;     </div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;     </div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="keyword">subroutine </span><a class="code" href="namespaceluna__methods.html#a80bd42c2c40927eb8372521ae1ab8957">luna_nogrowth</a>(max_daily_pchg,vcmx25_z,jmx25_z,enzs_z) </div><div class="line"><a name="l00755"></a><span class="lineno"><a class="line" href="namespaceluna__methods.html#a80bd42c2c40927eb8372521ae1ab8957">  755</a></span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (in)</span>    :: max_daily_pchg      <span class="comment">! maximum daily percentrage change for nitrogen allocation</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: vcmx25_z            <span class="comment">! leaf Vc,max25 (umol/m2 leaf/s) for canopy layer </span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: jmx25_z             <span class="comment">! leaf Jmax25 (umol electron/m**2/s) for canopy layer</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="keywordtype">real(dp)</span>, <span class="keywordtype">intent (inout)</span> :: enzs_z              <span class="comment">! enzyme decay status 1.0-fully active; 0-all decayed during stress</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordtype">real(dp)</span>                 :: max_daily_decay     <span class="comment">! maximum daily percentrage change for nitrogen allocation</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="comment">!INTEGER                :: nrad                ! number of canopy layers</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;<span class="comment">!INTEGER                :: z                   ! canopy layer index</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="comment">! need to determine if these really need to have each layer or are passed back to each layer in npp calc</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="comment">!nrad            = 12</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="comment">!assume enzyme turnover under maintenance is 10 times lower than enzyme change under growth</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;max_daily_decay = min(0.5, 0.1 * max_daily_pchg)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">!print*, &#39;LUNA nogrowth:&#39;, max_daily_decay</span></div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="comment">!print*, vcmx25_z(1)</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="comment">!do z = 1 , nrad</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; <span class="comment">!decay is set at only 50% of original enzyme in view that plant will need to maintain their basic functionality</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160; <span class="keywordflow">if</span>(enzs_z&gt;0.5) <span class="keywordflow">then</span> </div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  enzs_z   = enzs_z   * (1.0 - max_daily_decay)</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  jmx25_z  = jmx25_z  * (1.0 - max_daily_decay) </div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;  vcmx25_z = vcmx25_z * (1.0 - max_daily_decay) </div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="comment">!end do              </span></div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">!print*, vcmx25_z(1)</span></div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="namespaceluna__methods.html#a80bd42c2c40927eb8372521ae1ab8957">luna_nogrowth</a> </div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;<span class="comment">!----------------------------------------------------------------------!       </span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="keyword">end module </span><a class="code" href="namespaceluna__methods.html">luna_methods</a></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="ttc" id="namespaceluna__methods_html_a858f535bce43b4efd5058b8f78a60f42"><div class="ttname"><a href="namespaceluna__methods.html#a858f535bce43b4efd5058b8f78a60f42">luna_methods::resptbernacchi</a></div><div class="ttdeci">real(dp) function resptbernacchi(tleaf)</div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00737">luna_methods.f90:737</a></div></div>
<div class="ttc" id="namespaceluna__methods_html_aea6124b0932a79f49ddaf7872db92fd5"><div class="ttname"><a href="namespaceluna__methods.html#aea6124b0932a79f49ddaf7872db92fd5">luna_methods::luna_ninvestments</a></div><div class="ttdeci">subroutine luna_ninvestments(KcKjFlag, FNCa, Nlc, forc_pbot10, relh10, CO2a10, O2a10, PARi10, PARimx10, rb10, hourpd, tair10, tleafd10, tleafn10, Kj2Kc, Wc2Wjb0, JmaxCoef, Fc, Fj, NUEc, NUEj, NUEcref, NUEjref, NUEr, Kc, Kj, ci, Vcmax, Jmax, JmeanL, JmaxL, Net, Ncb, Nresp, PSN, RESP, gs_func, ftg0, ftg1)</div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00467">luna_methods.f90:467</a></div></div>
<div class="ttc" id="namespaceproductivity__luna__methods_html_a84f8154a56c2ec0e23c62040167fe919"><div class="ttname"><a href="namespaceproductivity__luna__methods.html#a84f8154a56c2ec0e23c62040167fe919">productivity_luna_methods::t_scalar</a></div><div class="ttdeci">real(dp) function t_scalar(t, jv, ttype, ftTopt, ftkHa, ftkHd, tmonth, jfv)</div><div class="ttdef"><b>Definition:</b> <a href="productivity__luna__methods_8f90_source.html#l00178">productivity_luna_methods.f90:178</a></div></div>
<div class="ttc" id="namespaceluna__methods_html_a74255d31dcbe80a6d972c7c6dcadf9f2"><div class="ttname"><a href="namespaceluna__methods.html#a74255d31dcbe80a6d972c7c6dcadf9f2">luna_methods::nue</a></div><div class="ttdeci">subroutine nue(o2a, ci, tgrow, tleaf, NUEj, NUEc, Kj2Kc, ttype, ftToptV, ftHaV, ftHdV, ftToptJ, ftHaJ, ftHdJ)</div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00656">luna_methods.f90:656</a></div></div>
<div class="ttc" id="namespacereal__precision_html"><div class="ttname"><a href="namespacereal__precision.html">real_precision</a></div><div class="ttdoc">Precision &amp;#39;dp&amp;#39; given by &amp;#39;selected_real_kind(P,R). where P is the precision ie. number of significant ...</div><div class="ttdef"><b>Definition:</b> <a href="real__precision_8f90_source.html#l00007">real_precision.f90:7</a></div></div>
<div class="ttc" id="namespaceluna__methods_html"><div class="ttname"><a href="namespaceluna__methods.html">luna_methods</a></div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00001">luna_methods.f90:1</a></div></div>
<div class="ttc" id="namespaceproductivity__luna__methods_html"><div class="ttname"><a href="namespaceproductivity__luna__methods.html">productivity_luna_methods</a></div><div class="ttdef"><b>Definition:</b> <a href="productivity__luna__methods_8f90_source.html#l00001">productivity_luna_methods.f90:1</a></div></div>
<div class="ttc" id="namespaceluna__methods_html_a1a163aa95715ebde3696a4337b9b8d84"><div class="ttname"><a href="namespaceluna__methods.html#a1a163aa95715ebde3696a4337b9b8d84">luna_methods::luna</a></div><div class="ttdeci">subroutine luna(z, vcmx25_z, jmx25_z, PNlc_z, enzs_z, rb10, sla, lnc, par240d, par240x, CO2a10, o2a10, hourpd, relh10_in, tair10, gs_func, ftg0, ftg1, max_daily_pchg, ttype, ftToptV, ftHaV, ftHdV, ftToptJ, ftHaJ, ftHdJ)</div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00042">luna_methods.f90:42</a></div></div>
<div class="ttc" id="namespaceluna__methods_html_a80bd42c2c40927eb8372521ae1ab8957"><div class="ttname"><a href="namespaceluna__methods.html#a80bd42c2c40927eb8372521ae1ab8957">luna_methods::luna_nogrowth</a></div><div class="ttdeci">subroutine luna_nogrowth(max_daily_pchg, vcmx25_z, jmx25_z, enzs_z)</div><div class="ttdef"><b>Definition:</b> <a href="luna__methods_8f90_source.html#l00755">luna_methods.f90:755</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="font-weight: bold;">&copy; 2018 Leverhulme Center for Climate Change Mitigation (LC3M)
      <a href="http://www.doxygen.org/index.html">
<!---        <img class="footer" src="LC3M2.png" alt="doxygen"/>
--->
      </a>
    </li>
  </ul>
</div>
</body>
</html>
